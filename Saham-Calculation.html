<!doctype html>
<html lang="id">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Saham Calculation</title>
    <style>
         :root {
            --bg: #f4f6fb;
            --card: #fff;
            --accent: #0b5ed7;
            --muted: #6b7280;
            --danger: #ef4444;
            --success: #16a34a;
        }
        
        body {
            font-family: Inter, system-ui, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--bg);
        }
        
        .container {
            max-width: 1100px;
            margin: 0 auto;
        }
        
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 6px 20px rgba(11, 78, 215, 0.06);
        }
        
        h1 {
            color: var(--accent);
            margin: 0 0 6px 0;
        }
        
        p.lead {
            margin: 0 0 12px 0;
            color: var(--muted);
        }
        
        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        
        button {
            padding: 8px 12px;
            border-radius: 8px;
            border: 0;
            cursor: pointer;
            font-weight: 600;
        }
        
        .btn-primary {
            background: var(--accent);
            color: #fff;
        }
        
        .btn-ghost {
            background: transparent;
            color: var(--accent);
            border: 1px solid #dbeafe;
        }
        
        .btn-danger {
            background: var(--danger);
            color: #fff;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 12px;
            margin-top: 12px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        th,
        td {
            padding: 8px 6px;
            border-bottom: 1px solid #eef2ff;
            text-align: left;
        }
        
        th {
            background: #fbfdff;
            color: #0f172a;
            font-weight: 700;
        }
        
        input[type="number"],
        input[type="text"],
        select {
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #e6e9ef;
            width: 100%;
            box-sizing: border-box;
        }
        
        .small {
            font-size: 12px;
            color: var(--muted);
        }
        
        .right {
            text-align: right;
        }
        
        .summary {
            background: #f8fafc;
            padding: 10px;
            border-radius: 8px;
        }
        
        .row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        
        .muted {
            color: var(--muted);
            font-size: 13px;
        }
        
        .actions-inline {
            display: flex;
            gap: 6px;
        }
        
        @media (max-width:900px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
        
        .badge {
            padding: 4px 8px;
            border-radius: 999px;
            background: #eef2ff;
            color: var(--accent);
            font-weight: 700;
            font-size: 12px;
        }
        
        .error {
            color: var(--danger);
            font-size: 13px;
        }
    </style>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container">
        <div class="card" role="main" aria-live="polite">
            <h1>Saham Calculation</h1>
            <p class="lead">Versi dinamis: multi-instrumen, grafik, simulasi harga, riwayat, dan ekspor CSV.</p>

            <div class="controls">
                <button id="addRow" class="btn-primary">Tambah Transaksi</button>
                <button id="recalc" class="btn-ghost">Recalculate</button>
                <button id="startSim" class="btn-ghost">Start Simulation</button>
                <button id="stopSim" class="btn-ghost" disabled>Stop Simulation</button>
                <div style="flex:1"></div>
                <div class="actions-inline">
                    <button id="exportCsv" class="btn-ghost">Export CSV</button>
                    <input id="importFile" type="file" accept=".csv" style="display:none" />
                    <button id="importBtn" class="btn-ghost">Import CSV</button>
                    <button id="clearAll" class="btn-danger">Clear All</button>
                </div>
            </div>

            <div class="grid">
                <div>
                    <table id="txTable" aria-label="Tabel transaksi">
                        <thead>
                            <tr>
                                <th>Instrumen</th>
                                <th>Harga Beli</th>
                                <th>Harga Jual</th>
                                <th>Jumlah</th>
                                <th>Lot</th>
                                <th>Biaya Beli</th>
                                <th>Biaya Jual</th>
                                <th class="right">Profit</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="txBody">
                            <!-- rows injected -->
                        </tbody>
                    </table>

                    <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
                        <label class="small">Default Lot Size</label>
                        <input id="defaultLot" type="number" min="1" value="100" style="width:100px" />
                        <label class="small" style="margin-left:8px">Mode Harga</label>
                        <select id="priceMode" style="width:160px">
              <option value="manual">Manual</option>
              <option value="simulate">Simulate</option>
              <option value="api">Fetch API (requires key)</option>
            </select>
                    </div>

                    <div id="errorBox" class="error" style="margin-top:8px; display:none"></div>
                </div>

                <div>
                    <div class="summary">
                        <div class="row">
                            <div class="muted">Total Investasi</div>
                            <div id="totalInvest">-</div>
                        </div>
                        <div class="row">
                            <div class="muted">Total Hasil Jual</div>
                            <div id="totalRevenue">-</div>
                        </div>
                        <div class="row">
                            <div class="muted">Total Profit / Rugi</div>
                            <div id="totalProfit">-</div>
                        </div>
                        <div class="row">
                            <div class="muted">Persentase</div>
                            <div id="totalPct">-</div>
                        </div>
                        <div style="margin-top:8px"><span class="badge" id="rowCount">0 transaksi</span></div>
                    </div>

                    <canvas id="profitChart" style="margin-top:12px; background:#fff; border-radius:8px; padding:8px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Utility functions
        function fmt(n) {
            return Number(n).toLocaleString('id-ID', {
                maximumFractionDigits: 2
            });
        }

        function parseNum(v) {
            return v === '' ? 0 : parseFloat(v) || 0;
        }

        // State
        let rows = [];
        let simInterval = null;
        let chart = null;

        // DOM
        const txBody = document.getElementById('txBody');
        const addRowBtn = document.getElementById('addRow');
        const recalcBtn = document.getElementById('recalc');
        const startSimBtn = document.getElementById('startSim');
        const stopSimBtn = document.getElementById('stopSim');
        const totalInvestEl = document.getElementById('totalInvest');
        const totalRevenueEl = document.getElementById('totalRevenue');
        const totalProfitEl = document.getElementById('totalProfit');
        const totalPctEl = document.getElementById('totalPct');
        const rowCountEl = document.getElementById('rowCount');
        const defaultLotEl = document.getElementById('defaultLot');
        const priceModeEl = document.getElementById('priceMode');
        const errorBox = document.getElementById('errorBox');
        const exportCsvBtn = document.getElementById('exportCsv');
        const importBtn = document.getElementById('importBtn');
        const importFile = document.getElementById('importFile');
        const clearAllBtn = document.getElementById('clearAll');

        // Initialize
        function init() {
            loadFromStorage();
            if (rows.length === 0) addRow();
            renderTable();
            initChart();
            recalc();
        }

        // Row factory
        function newRow(data = {}) {
            return {
                id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
                symbol: data.symbol || '',
                buyPrice: data.buyPrice || 0,
                sellPrice: data.sellPrice || 0,
                quantity: data.quantity || 0,
                lot: data.lot || parseInt(defaultLotEl.value) || 100,
                buyFeePct: data.buyFeePct || 0.15,
                sellFeePct: data.sellFeePct || 0.15,
                otherFee: data.otherFee || 0,
                lastPrice: data.lastPrice || 0,
                timestamp: Date.now()
            };
        }

        // Add / Remove
        function addRow(data) {
            rows.push(newRow(data));
            saveToStorage();
            renderTable();
            recalc();
        }

        function removeRow(id) {
            rows = rows.filter(r => r.id !== id);
            saveToStorage();
            renderTable();
            recalc();
        }

        // Render table
        function renderTable() {
            txBody.innerHTML = '';
            rows.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td><input data-id="${r.id}" data-field="symbol" type="text" value="${escapeHtml(r.symbol)}" placeholder="Ticker" /></td>
          <td><input data-id="${r.id}" data-field="buyPrice" type="number" step="0.01" min="0" value="${r.buyPrice}" /></td>
          <td><input data-id="${r.id}" data-field="sellPrice" type="number" step="0.01" min="0" value="${r.sellPrice}" /></td>
          <td><input data-id="${r.id}" data-field="quantity" type="number" step="1" min="0" value="${r.quantity}" /></td>
          <td><input data-id="${r.id}" data-field="lot" type="number" step="1" min="1" value="${r.lot}" /></td>
          <td><input data-id="${r.id}" data-field="buyFeePct" type="number" step="0.01" min="0" value="${r.buyFeePct}" /></td>
          <td><input data-id="${r.id}" data-field="sellFeePct" type="number" step="0.01" min="0" value="${r.sellFeePct}" /></td>
          <td class="right" id="profit-${r.id}">-</td>
          <td class="right"><button data-action="remove" data-id="${r.id}" class="btn-ghost">Hapus</button></td>
        `;
                txBody.appendChild(tr);
            });

            // Attach listeners
            txBody.querySelectorAll('input').forEach(inp => {
                inp.addEventListener('input', onCellEdit);
            });
            txBody.querySelectorAll('button[data-action="remove"]').forEach(b => {
                b.addEventListener('click', e => removeRow(e.target.dataset.id));
            });

            rowCountEl.textContent = `${rows.length} transaksi`;
        }

        function onCellEdit(e) {
            const id = e.target.dataset.id;
            const field = e.target.dataset.field;
            const val = e.target.type === 'number' ? parseNum(e.target.value) : e.target.value;
            const idx = rows.findIndex(r => r.id === id);
            if (idx === -1) return;
            rows[idx][field] = val;
            rows[idx].timestamp = Date.now();
            saveToStorage();
            recalcRow(rows[idx]);
            recalcTotals();
        }

        // Calculation per row
        function recalcRow(r) {
            const q = r.quantity || 0;
            const lot = r.lot || 1;
            const effectiveQty = q || lot; // if user uses lot field as quantity
            const buyGross = r.buyPrice * effectiveQty;
            const buyFee = buyGross * (r.buyFeePct / 100);
            const totalCost = buyGross + buyFee + (r.otherFee || 0);

            const sellGross = r.sellPrice * effectiveQty;
            const sellFee = sellGross * (r.sellFeePct / 100);
            const totalRevenue = sellGross - sellFee - (r.otherFee || 0);

            const profit = totalRevenue - totalCost;
            const pct = totalCost ? (profit / totalCost) * 100 : 0;

            const el = document.getElementById(`profit-${r.id}`);
            if (el) el.textContent = (profit >= 0 ? '+' : '') + fmt(profit) + ` (${(pct>=0?'+':'')}${pct.toFixed(2)}%)`;
            return {
                totalCost,
                totalRevenue,
                profit,
                pct
            };
        }

        // Totals
        function recalcTotals() {
            let invest = 0,
                revenue = 0,
                profit = 0;
            rows.forEach(r => {
                const q = r.quantity || 0;
                const effectiveQty = q || r.lot || 0;
                const buyGross = r.buyPrice * effectiveQty;
                const buyFee = buyGross * (r.buyFeePct / 100);
                const totalCost = buyGross + buyFee + (r.otherFee || 0);

                const sellGross = r.sellPrice * effectiveQty;
                const sellFee = sellGross * (r.sellFeePct / 100);
                const totalRevenue = sellGross - sellFee - (r.otherFee || 0);

                invest += totalCost;
                revenue += totalRevenue;
                profit += (totalRevenue - totalCost);
            });

            totalInvestEl.textContent = invest ? fmt(invest) : '-';
            totalRevenueEl.textContent = revenue ? fmt(revenue) : '-';
            totalProfitEl.textContent = profit ? ((profit >= 0 ? '+' : '') + fmt(profit)) : '-';
            totalPctEl.textContent = invest ? ((profit / invest * 100) >= 0 ? '+' : '') + (invest ? (profit / invest * 100).toFixed(2) : '0.00') + ' %' : '-';

            updateChart();
        }

        // Recalc all rows
        function recalc() {
            errorBox.style.display = 'none';
            rows.forEach(r => recalcRow(r));
            recalcTotals();
            saveToStorage();
        }

        // Storage
        function saveToStorage() {
            try {
                localStorage.setItem('saham_rows_v2', JSON.stringify(rows));
            } catch (e) {
                console.warn('Storage error', e);
            }
        }

        function loadFromStorage() {
            try {
                const raw = localStorage.getItem('saham_rows_v2');
                if (raw) {
                    const parsed = JSON.parse(raw);
                    if (Array.isArray(parsed)) rows = parsed;
                }
            } catch (e) {
                console.warn('Load error', e);
            }
        }

        function clearAll() {
            if (!confirm('Hapus semua transaksi dan riwayat?')) return;
            rows = [];
            saveToStorage();
            renderTable();
            recalc();
        }

        // Chart
        function initChart() {
            const ctx = document.getElementById('profitChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Profit per Transaksi',
                        backgroundColor: '#0b5ed7',
                        data: []
                    }, {
                        label: 'Cumulative Profit',
                        backgroundColor: '#16a34a',
                        data: [],
                        type: 'line',
                        fill: false,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            updateChart();
        }

        function updateChart() {
            if (!chart) return;
            const labels = rows.map(r => r.symbol || r.id.slice(-4));
            const profits = rows.map(r => recalcRow(r).profit);
            const cum = [];
            profits.reduce((acc, cur, i) => (cum[i] = acc + cur, acc + cur), 0);
            chart.data.labels = labels;
            chart.data.datasets[0].data = profits;
            chart.data.datasets[1].data = cum;
            chart.update();
        }

        // Simulation: random walk on lastPrice or sellPrice
        function startSimulation() {
            if (simInterval) return;
            startSimBtn.disabled = true;
            stopSimBtn.disabled = false;
            simInterval = setInterval(() => {
                // update each row price slightly
                rows = rows.map(r => {
                    const base = r.lastPrice || r.sellPrice || r.buyPrice || 0;
                    const changePct = (Math.random() - 0.5) * 0.02; // +/-1%
                    const newPrice = Math.max(0, base * (1 + changePct));
                    r.lastPrice = Number(newPrice.toFixed(2));
                    // if priceMode simulate, set sellPrice to lastPrice for calculation
                    if (priceModeEl.value === 'simulate') r.sellPrice = r.lastPrice;
                    return r;
                });
                renderTable(); // to update inputs if needed
                recalc();
            }, 1200);
        }

        function stopSimulation() {
            if (!simInterval) return;
            clearInterval(simInterval);
            simInterval = null;
            startSimBtn.disabled = false;
            stopSimBtn.disabled = true;
        }

        // CSV Export / Import
        function exportCSV() {
            const header = ['symbol', 'buyPrice', 'sellPrice', 'quantity', 'lot', 'buyFeePct', 'sellFeePct', 'otherFee', 'lastPrice', 'timestamp'];
            const rowsCsv = rows.map(r => header.map(h => `"${(r[h]||'')}"`).join(','));
            const csv = [header.join(','), ...rowsCsv].join('\n');
            const blob = new Blob([csv], {
                type: 'text/csv;charset=utf-8;'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'saham_export.csv';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        function importCSVFile(file) {
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const text = e.target.result;
                    const lines = text.split(/\r?\n/).filter(Boolean);
                    const header = lines.shift().split(',').map(h => h.replace(/"/g, '').trim());
                    const imported = lines.map(line => {
                        const cols = line.split(',').map(c => c.replace(/"/g, ''));
                        const obj = {};
                        header.forEach((h, i) => obj[h] = cols[i] || '');
                        // convert numeric fields
                        return newRow({
                            symbol: obj.symbol || '',
                            buyPrice: parseNum(obj.buyPrice),
                            sellPrice: parseNum(obj.sellPrice),
                            quantity: parseInt(obj.quantity) || 0,
                            lot: parseInt(obj.lot) || parseInt(defaultLotEl.value) || 100,
                            buyFeePct: parseNum(obj.buyFeePct) || 0,
                            sellFeePct: parseNum(obj.sellFeePct) || 0,
                            otherFee: parseNum(obj.otherFee) || 0,
                            lastPrice: parseNum(obj.lastPrice) || 0
                        });
                    });
                    rows = rows.concat(imported);
                    saveToStorage();
                    renderTable();
                    recalc();
                } catch (err) {
                    showError('Gagal mengimpor CSV: format tidak valid');
                }
            };
            reader.readAsText(file);
        }

        // Helpers
        function showError(msg) {
            errorBox.textContent = msg;
            errorBox.style.display = 'block';
            setTimeout(() => errorBox.style.display = 'none', 6000);
        }

        function escapeHtml(s) {
            return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        // Event bindings
        addRowBtn.addEventListener('click', () => addRow());
        recalcBtn.addEventListener('click', () => recalc());
        startSimBtn.addEventListener('click', () => startSimulation());
        stopSimBtn.addEventListener('click', () => stopSimulation());
        exportCsvBtn.addEventListener('click', () => exportCSV());
        importBtn.addEventListener('click', () => importFile.click());
        importFile.addEventListener('change', e => {
            const f = e.target.files[0];
            if (f) importCSVFile(f);
            importFile.value = '';
        });
        clearAllBtn.addEventListener('click', () => clearAll());

        // Optional: API fetch placeholder (requires user API key)
        async function fetchPriceFromApi(symbol, apiKey) {
            // Example: if you have an API, implement here.
            // This function is intentionally left as a placeholder.
            // Do not call external APIs without an API key.
            return null;
        }

        // On unload save
        window.addEventListener('beforeunload', () => saveToStorage());

        // Start
        init();
    </script>
</body>

</html>